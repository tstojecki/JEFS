/*  JEFS - Javascript Editor for SharePoint, MIT License, (c) Tomek Stojecki */var JEFS=JEFS||{};JEFS.$=jQuery.noConflict(!0),JEFS.script="",JEFS.includes="<!-- jefs script references -->",JEFS.siteServerRelativeUrl=null,function(a,b,c){function d(){var b='<?xml version="1.0" encoding="utf-8"?>             <soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">             <soap:Body>                 <GetListItems xmlns="http://schemas.microsoft.com/sharepoint/soap/">                     <listName>JEFS</listName>                     <viewFields>                     <ViewFields>                         <FieldRef Name="Title" />                         <FieldRef Name="Content" />                         <FieldRef Name="HeadContent" />                     </ViewFields>                     </viewFields>                     <query>                     <Query>                         <Where><Eq><FieldRef Name="Title"/><Value Type="Text">'+(location.pathname.indexOf("%20")>0?location.pathname:encodeURI(location.pathname))+"</Value></Eq></Where>                     </Query>                     </query>                     <QueryOptions>                     <queryOptions>                         <IncludeMandatoryColumns>FALSE</IncludeMandatoryColumns>                     </queryOptions>                     </QueryOptions>                 </GetListItems>             </soap:Body>         </soap:Envelope>";a.ajax({url:JEFS.siteServerRelativeUrl+"_vti_bin/lists.asmx",type:"POST",contentType:'text/xml; charset="utf-8"',dataType:a.browser.msie?"text":"xml",data:b,async:!1}).done(function(b){var c=a(b).find("row:first");c.length>0&&(JEFS.script=c.attr("ows_Content"),JEFS.includes=c.attr("ows_HeadContent"))}).fail(function(a,b,c){throw"The SOAP call to GetListItems failed with the error of: "+c.toString()})}a(c).ready(function(){function h(){a("head").append('<script type="text/javascript">'+JEFS.script+"</script>")}var b,c,e,f=!1,g=[];_spPageContextInfo&&(b=_spPageContextInfo.siteServerRelativeUrl,c=_spPageContextInfo.webServerRelativeUrl),b.match(/\/$/)||(b+="/"),JEFS.siteServerRelativeUrl=b,d(),a("<link>").appendTo("head").attr({rel:"stylesheet",type:"text/css",href:b+"lists/JEFS/codemirror.css"}),JEFS.includes!==""&&(a(JEFS.includes).filter("script").each(function(){g.push(a(this).attr("src"))}),g.length>0?$LAB.script(g).wait(function(){JEFS.script!==""&&h()}):h())})}(JEFS.$,window,document),JEFS.editor=function(a,b,c,d){function h(){var b=a('<div id="jefs_dialog" style="font-size:10pt"><form><textarea id="jefs_editor"></textarea><textarea id="jefs_resources"></textarea><div style="float:left;width:150px;margin-top: 15px;font-size:10px;color:#000;margin-right:15px;"><input type="checkbox" id="jefs_wrap" /> wrap lines<br /><input type="checkbox" id="jefs_reload" checked="checked" /> reload after save</div><div id="jefs_rpanel" style="text-align:right;margin-top:5px; width:300px;float:right;font-size: 11px;">include: <select id="jefs_libraries"><option value="none">None</option></select><a id="jefs_swap" href="javascript:void(0);" style="margin:0 10px 0 5px;">resources</a><button type="button" id="jefs_save" style="border: solid 1px #c3c3c3;background-color:#f1f1f1;padding: 3px;width: 85px;margin-right:8px;margin-top:15px;color: #21374C;font-size:11px;font-weight: bold;font-family: verdana;">save</button></div><div style="clear:both;"></div></form></div>');e={main:b,editorMainArea:b.find("#jefs_editor"),editorResArea:b.find("#jefs_resources"),optionWrap:b.find("#jefs_wrap"),optionReload:b.find("#jefs_reload"),buttonSwap:b.find("#jefs_swap"),buttonSave:b.find("#jefs_save"),selectLibraries:b.find("#jefs_libraries"),rightPanel:b.find("#jefs_rpanel")},i(),f=j(e.editorMainArea.get(0),{value:JEFS.script,mode:"javascript",lineNumbers:!0,theme:"night",lineWrapping:e.optionWrap.is(":checked")}),e.editorMainWrapper=a(f.getWrapperElement()),g=j(e.editorResArea.get(0),{value:JEFS.includes,mode:"text/html",theme:"default"}),e.editorResWrapper=a(g.getWrapperElement()),e.editorResWrapper.hide(),p()}function i(){e.buttonSave.click(l),e.buttonSwap.click(o),e.optionWrap.click(n),e.selectLibraries.change(m)}function j(a,b){return CodeMirror(function(b){a.parentNode.replaceChild(b,a)},b)}function k(){return e.editorMainWrapper.is(":visible")}function l(){var a=new SP.ClientContext.get_current,c=a.get_site().get_rootWeb(),d=c.get_lists().getByTitle("JEFS"),h='<View><Query><Where><Eq><FieldRef Name="Title" /><Value Type="Text">'+(location.pathname.indexOf("%20")>0?location.pathname:encodeURI(location.pathname))+'</Value></Eq></Where></Query><ViewFields><FieldRef Name="Title" /></ViewFields></View>',i=new SP.CamlQuery;i.set_viewXml(h);var j=d.getItems(i);a.load(j),a.executeQueryAsync(function(){var c=j.getEnumerator(),h=null;while(c.moveNext())h=c.get_current();if(h==null){var i=new SP.ListItemCreationInformation;h=d.addItem(i),h.set_item("Title",location.pathname)}h.set_item("Content",f.getValue()),h.set_item("HeadContent",g.getValue()),h.update();var k=SP.UI.Notify.addNotification("Saving content...",!0);a.executeQueryAsync(function(){SP.UI.Notify.removeNotification(k),SP.UI.Status.addStatus("Javascript Editor content saved!");if(e.optionReload.is(":checked")){b.location.reload(!0);return}},function(a,b){var c=SP.UI.Status.addStatus("Javascript Editor failed while saving content. Message:"+b.get_message());SP.UI.Status.setStatusPriColor(c,"red")})},function(a,b){var c=SP.UI.Status.addStatus("Javascript Editor failed while getting content. Message:"+b.get_message());SP.UI.Status.setStatusPriColor(c,"red")}),SP.UI.ModalDialog.commonModalDialogClose(SP.UI.DialogResult.cancel,"Save clicked")}function m(){var a=g.getValue()||"",b=e.selectLibraries.val(),c='<script class="jefs" type="text/javascript" src="'+e.selectLibraries.val()+'"></script>';b==="none"?a="<!-- JEFS script includes -->":a.match(c)||(a=a+"\n"+c),g.setValue(a),k()&&o()}function n(){f.setOption("lineWrapping",e.optionWrap.is(":checked"))}function o(){k()?(e.editorMainWrapper.hide(),e.editorResWrapper.show(),e.optionWrap.attr({disabled:"disabled"}),e.buttonSwap.html("back to js"),g.refresh()):(e.editorMainWrapper.show(),e.editorResWrapper.hide(),e.optionWrap.removeAttr("disabled"),e.buttonSwap.html("resources"),f.refresh())}function p(){a.ajax({url:JEFS.siteServerRelativeUrl+"lists/jefs/libraries.txt",dataType:"text"}).done(function(b){var c='<option value="none">None</option>',d=0,f=JSON.parse?JSON.parse(b):a.parseJSON(b);for(;d<f.length;d++)c+='<option value="'+f[d].url+'">'+f[d].name+"</option>";e.selectLibraries.html(c)}).fail(function(a,b,c){throw"The ajax call to get the list of libraries failed call with the following error: "+c.toString()})}var e=null,f=null,g=null;return{maximized:!1,launch:function(){var d,g,i,j=!1,k=0;h(),d={html:e.main.get(0),autoSize:!0,allowMaximize:!0,title:"Type your javascript here",showClose:!0},i=SP.UI.ModalDialog.get_childDialog();if(i!=null){j=confirm("Due to an issue with displaying multiple dialogs at once, the editor will close the dialog and open the form in a full page mode. The javascript you save will work either in a dialog or a full page mode. Do you want to continue?");if(!j)return;k=b.location.href.indexOf("?"),b.parent.location.href=k>0?b.location.href.substring(0,k):b.location.href;return}g=SP.UI.ModalDialog.showModalDialog(d),f.refresh(),a(".ms-dlgCloseBtn[title=Maximize]").click(function(){var b,d,g,h,i,j=600;b=a("#jefs_dialog"),d=b.find("div.CodeMirror-scroll:eq(0)"),g=b.find("div.CodeMirror-scroll:eq(1)"),this.maximized?(d.css("height",""),g.css("height",""),e.rightPanel.css("width","300px"),this.maximized=!1):(a.browser.msie?(c.documentElement.clientHeight&&(j=c.documentElement.clientHeight),c.body.clientHeight&&(j=c.body.clientHeight),i=(j-115).toString()+"px"):(h=parseInt(b.parent().parent().css("height").replace("px","")),i=(h-95).toString()+"px"),d.css("height",i),g.css("height",i),e.rightPanel.css("width",""),this.maximized=!0),f.refresh()})}}}(JEFS.$,window,document);